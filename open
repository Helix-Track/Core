#!/bin/bash

# TODO: Clone script to download the opening files and scripts that are not the part of Project Toolkit

HERE=$(pwd)
DIR_HOME=$(eval echo ~"$USER")

if [ -z "$SUBMODULES_HOME" ]; then

    FILE_ZSH_RC="$DIR_HOME/.zshrc"
    FILE_BASH_RC="$DIR_HOME/.bashrc"

    if test -e "$FILE_ZSH_RC"; then

        FILE_RC="$FILE_ZSH_RC"

    else

        if test -e "$FILE_BASH_RC"; then

        FILE_RC="$FILE_BASH_RC"

        else

        echo "ERROR: No '$FILE_ZSH_RC' or '$FILE_BASH_RC' found on the system"
        exit 1
        fi
    fi

    # shellcheck disable=SC1090
    . "$FILE_RC"
fi

if [ -z "$SUBMODULES_HOME" ]; then

  echo "ERROR: The 'SUBMODULES_HOME' variable is not defined"  
  exit 1
fi

SCRIPT_DO_OPEN="$HERE/do_open"
SCRIPT_PRE_OPEN="$HERE/pre_open"
SCRIPT_POST_OPEN="$HERE/post_open"

if test -e "$SCRIPT_PRE_OPEN"; then

    if ! sh "$SCRIPT_PRE_OPEN"; then

        echo "ERROR: Pre-open failed"
        exit 1
    fi
fi


SCRIPT_PREPARE_LOCAL="$HERE/prepare"

if ! test -e "$SCRIPT_PREPARE_LOCAL" || ! test -e "$SCRIPT_DO_OPEN"; then

    SCRIPT_PREPARE_TOOLKIT="$SUBMODULES_HOME/prepare"

    if test -e "$SCRIPT_PREPARE_TOOLKIT"; then

        if ! sh "$SCRIPT_PREPARE_TOOLKIT"; then

            echo "ERROR: Script failed '$SCRIPT_PREPARE_TOOLKIT'"
            exit 1
        fi

    else

        echo "ERROR: Script not found '$SCRIPT_PREPARE_TOOLKIT'"
        exit 1
    fi
fi

if test -e "$SCRIPT_DO_OPEN"; then

  sh "$SCRIPT_DO_OPEN"

fi

if test -e "$SCRIPT_POST_OPEN"; then

    if ! sh "$SCRIPT_POST_OPEN"; then

        echo "ERROR: Post-open failed"
        exit 1
    fi
fi
